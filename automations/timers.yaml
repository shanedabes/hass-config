---
# start timer when tag is scanned
- id: nfc_timer_start
  alias: Start timers using nfc tags
  mode: single
  max_exceeded: silent

  variables:
    tags:
      washing_machine_timer: "timer.washing_machine"
      dryer_mixed_load_timer: "timer.dryer_mixed_load"

  trigger:
    platform: event
    event_type: tag_scanned

  condition:
    - "{{ trigger.event.data.tag_id in tags }}"

  action:
    - variables:
        timer_id: "{{ tags[trigger.event.data.tag_id] }}"

    - service: timer.start
      data:
        entity_id: "{{ timer_id }}"

- id: timer_finished
  alias: Timer finished
  mode: single
  max_exceeded: silent

  variables:
    timers:
      timer.washing_machine:
        summary: The washing machine has finished
        icon: washing-machine.png
        urgency: critical
      timer.dryer_mixed_load:
        summary: The dryer has finished
        icon: tumble-dryer.png
      timer.bath_fill:
        summary: The bath is full
        icon: water-pump.png

  trigger:
    platform: event
    event_type: timer.finished

  condition:
    - "{{ trigger.event.data.entity_id in timers }}"

  action:
    - variables:
        timer_dict: "{{ timers[trigger.event.data.entity_id] }}"

    - service: script.presence_notify
      data:
        message: "{{ timer_dict.summary }}"
        icon: "{{ timer_dict.icon }}"

- id: bedtime_heating
  alias: Turn off heating at bedtime after a delay
  mode: single

  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.bedtime_heating

  action:
    - service: climate.set_temperature
      entity_id: climate.bedroom
      data:
        temperature: 12

- id: presence_heating
  alias: Turn on heating after timer finishes
  mode: single

  trigger:
    platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.presence_heating

  action:
    - service: script.presence_heating

- id: wigeon_suspend
  alias: Suspend wigeon after timer finishes
  mode: single

  trigger:
    platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.wigeon_suspend

  action:
    - service: switch.turn_off
      entity_id: switch.wigeon

- id: humidifier_active
  alias: Set humidifier active after timer finishes
  mode: single

  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.bedroom_humidifier_active

  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.bedroom_humidifier_active
